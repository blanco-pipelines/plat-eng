# Disk Management and Filesystems

Disk management is a fundamental responsibility for Linux system administrators. Understanding how to view disk information, create partitions, format filesystems, and mount storage devices enables you to expand storage capacity, organize data, and troubleshoot disk-related issues.

Every file in Linux exists on a filesystem mounted to a directory. Whether you're adding a new disk, mounting external storage, or configuring persistent mounts at boot time, these skills are essential for maintaining storage infrastructure in development and production environments.

The `/etc/fstab` file controls which filesystems mount automatically at boot, making it critical for system stability. A misconfigured fstab can prevent your system from booting, so understanding its syntax and testing changes carefully is crucial.

### Estimated Time: 30 Minutes

## Part 1: Viewing Disk and Filesystem Information

1. Create a working directory for this lab
```
mkdir -p ~/disk_lab && cd ~/disk_lab
```

2. List all block devices (disks and partitions)
```
lsblk
```

**Understanding the output:**
- `NAME` - Device name (sda, nvme0n1, etc.)
- `MAJ:MIN` - Major and minor device numbers
- `RM` - Removable device (1 = yes, 0 = no)
- `SIZE` - Device or partition size
- `TYPE` - Device type (disk, part, lvm, etc.)
- `MOUNTPOINT` - Where the filesystem is mounted

3. Show detailed block device information
```
lsblk -f
```

This adds filesystem type, UUID, and usage information.

4. View partition table information
```
sudo fdisk -l
```

5. Display disk usage for mounted filesystems
```
df -h
```

**Flags explained:**
- `-h` - Human-readable sizes (GB, MB instead of bytes)

6. Show disk usage including filesystem type and inodes
```
df -hT
df -i  # inode usage (important for many small files)
```

7. Display detailed disk information with blkid
```
sudo blkid
```

This shows UUIDs, filesystem types, and partition types—useful for fstab configuration.

## Part 2: Understanding Mount Points

Mount points are directories where filesystems are attached to the directory tree. Everything in Linux is accessed through the unified directory structure starting at `/`.

1. View all currently mounted filesystems
```
mount | column -t
```

2. Check what's mounted at specific locations
```
mount | grep "^/"
findmnt /
```

3. Use findmnt for a tree view of mount points
```
findmnt
findmnt -t ext4,xfs  # Show only specific filesystem types
```

4. Create a test directory to use as a mount point
```
mkdir -p ~/disk_lab/mnt_test
```

## Part 3: Creating and Using a Loop Device

Since we likely don't have spare physical disks, we'll use a loop device—a file that acts like a block device. This is perfect for practice and testing.

1. Create a 100MB file to use as a virtual disk
```
dd if=/dev/zero of=~/disk_lab/virtual_disk.img bs=1M count=100
```

**Command explained:**
- `if=/dev/zero` - Input file (source of null bytes)
- `of=virtual_disk.img` - Output file
- `bs=1M` - Block size (1 megabyte)
- `count=100` - Number of blocks (100 MB total)

2. Verify the file was created
```
ls -lh ~/disk_lab/virtual_disk.img
file ~/disk_lab/virtual_disk.img
```

3. Set up the file as a loop device
```
sudo losetup -fP ~/disk_lab/virtual_disk.img
```

**Flags explained:**
- `-f` - Find the first unused loop device
- `-P` - Force kernel to scan partition table

4. Find which loop device was assigned
```
LOOP_DEVICE=$(losetup -j ~/disk_lab/virtual_disk.img | cut -d: -f1)
echo "Loop device: $LOOP_DEVICE"
```

5. Verify the loop device
```
lsblk | grep loop
sudo losetup -l
```

## Part 4: Creating a Filesystem

1. Create an ext4 filesystem on the loop device
```
sudo mkfs.ext4 -L "TestDisk" $LOOP_DEVICE
```

**Flags explained:**
- `-L "TestDisk"` - Set filesystem label

**Common filesystem types:**
- `ext4` - Default for most Linux distributions (reliable, mature)
- `xfs` - High-performance, good for large files (default on RHEL/Amazon Linux)
- `btrfs` - Modern with snapshots and compression features
- `vfat` - Compatible with Windows (FAT32)

2. Verify the filesystem was created
```
sudo blkid $LOOP_DEVICE
lsblk -f | grep loop
```

Notice the filesystem type (ext4) and UUID.

## Part 5: Mounting and Unmounting Filesystems

1. Mount the filesystem to your test directory
```
sudo mount $LOOP_DEVICE ~/disk_lab/mnt_test
```

2. Verify it's mounted
```
mount | grep mnt_test
df -h | grep mnt_test
lsblk | grep loop
```

3. Create some test files on the mounted filesystem
```
sudo touch ~/disk_lab/mnt_test/test_file.txt
echo "Hello from mounted filesystem" | sudo tee ~/disk_lab/mnt_test/test_file.txt
ls -la ~/disk_lab/mnt_test/
```

4. Check disk usage on the mounted filesystem
```
df -h ~/disk_lab/mnt_test/
```

5. Unmount the filesystem
```
sudo umount ~/disk_lab/mnt_test
```

6. Verify it's unmounted
```
mount | grep mnt_test
ls ~/disk_lab/mnt_test/  # Should be empty now
```

7. Remount and verify the data persisted
```
sudo mount $LOOP_DEVICE ~/disk_lab/mnt_test
cat ~/disk_lab/mnt_test/test_file.txt
```

## Part 6: Understanding /etc/fstab

The `/etc/fstab` file defines filesystems that should mount automatically at boot. Each line specifies a filesystem to mount.

1. View the current fstab configuration
```
cat /etc/fstab
```

2. Understand the fstab format:
```
# <device>  <mount point>  <type>  <options>  <dump>  <pass>
UUID=xxx    /              ext4    defaults   0       1
UUID=yyy    /boot          xfs     defaults   0       2
/dev/sdb1   /data          ext4    defaults   0       2
```

**Field explanations:**
- **Device**: UUID, device path, or label (identifies which filesystem to mount)
- **Mount point**: Directory where filesystem mounts
- **Type**: Filesystem type (ext4, xfs, vfat, etc.)
- **Options**: Mount options (defaults, noatime, ro, etc.)
- **Dump**: Backup utility flag (0 = don't backup, 1 = backup)
- **Pass**: fsck check order at boot (0 = no check, 1 = root, 2 = other)

3. View filesystem UUIDs (used in fstab for reliability)
```
sudo blkid
```

**Why use UUID instead of device names?**
- Device names (/dev/sda1) can change between reboots
- UUIDs are unique and persistent
- More reliable in production environments

4. Examine each entry in your fstab
```
grep -v '^#' /etc/fstab | grep -v '^$'
```

This shows only the active (non-comment, non-empty) lines.

## Part 7: Understanding Mount Options

Mount options in fstab control how filesystems behave. Understanding these is crucial for system administration.

1. Review common mount options:
```
cat << 'EOF'
Common Mount Options:
---------------------
defaults     - Use default options (rw, suid, dev, exec, auto, nouser, async)
noatime      - Don't update access times (performance improvement)
ro           - Read-only
rw           - Read-write
noexec       - Don't allow execution of binaries
nosuid       - Don't allow setuid/setgid bits
auto         - Mount at boot (default)
noauto       - Don't mount at boot (mount manually)
user         - Allow regular users to mount
nofail       - Don't report errors if device doesn't exist at boot
EOF
```

2. View which mount options are currently in use
```
findmnt -o TARGET,SOURCE,FSTYPE,OPTIONS
```

3. Look at mount options for specific filesystem types
```
# View ext4 mount options
findmnt -t ext4 -o TARGET,OPTIONS

# View tmpfs mount options
findmnt -t tmpfs -o TARGET,OPTIONS
```

4. Understand what a sample fstab entry would look like (informational only)
```
cat << 'EOF'
Sample fstab Entry Format:
-------------------------
UUID=12345678-1234-1234-1234-123456789abc  /data  ext4  defaults,noatime  0  2

Breaking this down:
- UUID identifies the specific filesystem
- /data is where it will be mounted
- ext4 is the filesystem type
- defaults,noatime are mount options
- 0 means don't use dump backup utility
- 2 means check this filesystem after root (which uses 1)
EOF
```

## Part 8: Exploring Mounted Filesystems

Let's explore the filesystems currently mounted on your system and understand how they relate to fstab.

1. Compare fstab entries with currently mounted filesystems
```
echo "=== Filesystems defined in /etc/fstab ==="
grep -v '^#' /etc/fstab | grep -v '^$' | column -t
echo ""
echo "=== Currently mounted filesystems ==="
findmnt --fstab --evaluate
```

2. Check for filesystems mounted but not in fstab
```
echo "=== Filesystems mounted but NOT in fstab ==="
findmnt --verify
```

3. View mount options being used vs what's in fstab
```
# This shows if actual mount options differ from fstab
findmnt --verify --verbose
```

**Important Notes:**
- ⚠️ **Never edit /etc/fstab without a backup and recovery plan**
- A broken fstab can prevent the system from booting
- Always test configuration with `mount -a` changes before rebooting
- Keep console access available when working with critical files
- In production, use configuration management tools to manage fstab

## Part 9: Disk Usage Analysis

1. Check overall disk usage
```
df -h
```

2. Find large directories
```
sudo du -h --max-depth=1 /var | sort -hr | head -10
sudo du -h --max-depth=1 /home | sort -hr | head -10
```

3. Find the largest files in your home directory
```
find ~ -type f -exec du -h {} + 2>/dev/null | sort -hr | head -20
```

4. Check inode usage (important when storing many small files)
```
df -i
```

**Understanding inodes:**
- Each file uses one inode (metadata structure)
- You can run out of inodes even with free disk space
- Common with millions of small files (logs, cache)

## Cleanup

1. Unmount the loop device
```
sudo umount ~/disk_lab/mnt_test 2>/dev/null || true
```

2. Detach the loop device
```
sudo losetup -d $LOOP_DEVICE
```

3. Verify cleanup
```
losetup -l | grep virtual_disk
mount | grep mnt_test
```

4. Remove test files
```
cd ~
rm -rf ~/disk_lab
```

## Conclusion

In this lab, you mastered essential disk management skills for Linux system administration:

- **Disk inspection**: Using `lsblk`, `fdisk`, `df`, and `blkid` to view disk and partition information
- **Block devices**: Understanding how physical and virtual disks appear in Linux
- **Filesystems**: Creating filesystems with `mkfs` and understanding ext4, xfs, and other types
- **Mounting**: Manually mounting and unmounting filesystems with `mount` and `umount`
- **fstab analysis**: Reading and understanding `/etc/fstab` structure, UUIDs, mount options, and their purpose
- **Loop devices**: Using file-backed loop devices for testing and development
- **Disk usage analysis**: Finding large files and directories with `du` and monitoring inode usage

These skills are critical for:
- Adding new storage to systems
- Managing cloud volumes (EBS, persistent disks)
- Configuring database and application storage
- Troubleshooting "disk full" issues
- Setting up NFS, CIFS, or other network filesystems
- Understanding system boot configurations and mount behavior

Understanding disk management enables you to maintain storage infrastructure confidently, whether you're working with physical servers, virtual machines, or cloud instances. The concepts you've learned here apply across all modern Linux distributions and cloud platforms.

**⚠️ Important Reminders:**
- `/etc/fstab` is a critical system file—always have backups and recovery access before making changes
- Use UUIDs for reliability in production
- Never force unmount busy filesystems without understanding the consequences
- Keep console access when testing storage configurations on remote systems
- Study existing fstab configurations to understand your system's storage layout
