# Lab 1.4: GitHub OIDC Authentication for AWS

## Overview

In traditional CI/CD workflows, you'd store AWS access keys as secrets in GitHub. This has several problems:

- Long-lived credentials can be compromised
- Keys need rotation and management
- If someone gains access to your repository secrets, they have full AWS access
- No easy way to audit who did what

**OpenID Connect (OIDC)** solves this by allowing GitHub Actions to assume AWS IAM roles temporarily without storing any credentials.

In this lab, you'll configure GitHub OIDC authentication with AWS, allowing your GitHub Actions workflows to securely access AWS resources without storing access keys.

**What You'll Learn:**
- How OIDC authentication works
- Setting up AWS IAM Identity Provider for GitHub
- Creating IAM roles with trust policies
- Configuring GitHub Actions to assume AWS roles
- Security best practices for temporary credentials

---

## Prerequisites

- AWS account with IAM permissions
- GitHub account
- Basic understanding of IAM roles and policies
- Completed previous labs (optional, but helpful for context)

---

## Understanding OIDC Authentication

### Traditional Approach (Don't do this!)
```
GitHub Secrets:
  AWS_ACCESS_KEY_ID: AKIAIOSFODNN7EXAMPLE
  AWS_SECRET_ACCESS_KEY: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY

Problems:
  - Long-lived credentials
  - Risk of exposure
  - Manual rotation required
  - Hard to track usage
```

### OIDC Approach (Modern & Secure!)
```
GitHub Actions Workflow
       ↓
Request temporary token from GitHub OIDC provider
       ↓
AWS validates token with GitHub
       ↓
AWS issues temporary credentials (valid for ~1 hour)
       ↓
Workflow uses temporary credentials
       ↓
Credentials expire automatically

Benefits:
  ✅ No stored credentials
  ✅ Automatic expiration
  ✅ Role-based access control
  ✅ Full audit trail
```

---

## Part 1: Create GitHub OIDC Identity Provider in AWS (10 minutes)

### 1.1 Create OIDC Provider via AWS Console

1. Log in to **AWS Console**
2. Navigate to **IAM** → **Identity providers**
3. Click **Add provider**
4. Configure:
   - **Provider type:** OpenID Connect
   - **Provider URL:** `https://token.actions.githubusercontent.com`
   - Click **Get thumbprint** (it will auto-populate)
   - **Audience:** `sts.amazonaws.com`
5. Click **Add provider**

### 1.2 Verify Provider Creation

You should see the provider listed:
- **Provider:** `token.actions.githubusercontent.com`
- **Type:** OpenID Connect
- **Audience:** `sts.amazonaws.com`

### 1.3 Alternative: Create via AWS CLI

If you prefer CLI:

```bash
# Create OIDC provider 
aws iam create-open-id-connect-provider \
  --url https://token.actions.githubusercontent.com \
  --client-id-list sts.amazonaws.com

# Verify creation
aws iam list-open-id-connect-providers
```

---

## Part 2: Create IAM Policy for GitHub Actions (10 minutes)

### 2.1 Determine Required Permissions

For the upcoming labs, GitHub Actions needs permissions for:
- **Packer (Lab 3.2):** Build custom AMIs (EC2, AMI, snapshot operations)
- **Terraform (Lab 3.1):** Provision infrastructure (VPC, EC2, ALB, ASG, IAM)

### 2.2 Create IAM Policy

**Create file: `github-actions-policy.json`**

This comprehensive policy covers all needs for Labs 2.2, 2.3, and 2.4:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "EC2FullAccess",
      "Effect": "Allow",
      "Action": [
        "ec2:*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "VPCFullAccess",
      "Effect": "Allow",
      "Action": [
        "ec2:*Vpc*",
        "ec2:*Subnet*",
        "ec2:*Gateway*",
        "ec2:*RouteTable*",
        "ec2:*NetworkAcl*",
        "ec2:*SecurityGroup*",
        "ec2:*NetworkInterface*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "ELBFullAccess",
      "Effect": "Allow",
      "Action": [
        "elasticloadbalancing:*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "AutoScalingFullAccess",
      "Effect": "Allow",
      "Action": [
        "autoscaling:*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "IAMReadWrite",
      "Effect": "Allow",
      "Action": [
        "iam:CreateRole",
        "iam:DeleteRole",
        "iam:GetRole",
        "iam:PassRole",
        "iam:AttachRolePolicy",
        "iam:DetachRolePolicy",
        "iam:ListAttachedRolePolicies",
        "iam:ListRolePolicies",
        "iam:CreateInstanceProfile",
        "iam:DeleteInstanceProfile",
        "iam:GetInstanceProfile",
        "iam:AddRoleToInstanceProfile",
        "iam:RemoveRoleFromInstanceProfile",
        "iam:ListInstanceProfiles",
        "iam:ListInstanceProfilesForRole",
        "iam:TagRole",
        "iam:TagInstanceProfile"
      ],
      "Resource": "*"
    }
  ]
}
```

**Note:** This is a comprehensive policy for learning environments. In production, you'd scope permissions more tightly per workflow.

### 2.3 Create Policy in AWS

```bash
aws iam create-policy \
  --policy-name GitHubActionsDeploymentPolicy \
  --policy-document file://github-actions-policy.json \
  --description "Allows GitHub Actions to run Packer, Terraform, and Ansible workflows"
```

**Save the Policy ARN from the output!**

Example output:
```json
{
  "Policy": {
    "PolicyName": "GitHubActionsDeploymentPolicy",
    "Arn": "arn:aws:iam::123456789012:policy/GitHubActionsDeploymentPolicy"
  }
}
```

---

## Part 3: Create IAM Role with Trust Policy (15 minutes)

### 3.1 Understanding Trust Policies

A trust policy defines **who** can assume the role. For GitHub OIDC:
- **Principal:** The GitHub OIDC provider
- **Condition:** Only specific repositories can assume the role

### 3.2 Create Trust Policy

**Create file: `github-trust-policy.json`**

**Replace the following:**
- `YOUR-ACCOUNT-ID` with your AWS account ID
- `YOUR-GITHUB-USERNAME` with your GitHub username
- `YOUR-REPO-PREFIX` with at least 6 characters of your repository name (e.g., `fastap` for all repos starting with "fastap")

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::YOUR-ACCOUNT-ID:oidc-provider/token.actions.githubusercontent.com"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
        },
        "StringLike": {
          "token.actions.githubusercontent.com:sub": "repo:YOUR-GITHUB-USERNAME/*:*"
        }
      }
    }
  ]
}
```

### 3.3 Get Your AWS Account ID

```bash
aws sts get-caller-identity --query Account --output text
```

### 3.4 Create the IAM Role

```bash
# Create the role
aws iam create-role \
  --role-name GitHubActionsDeploymentRole \
  --assume-role-policy-document file://github-trust-policy.json \
  --description "Role for GitHub Actions to run Packer, Terraform, and Ansible workflows"

# Attach the policy to the role
aws iam attach-role-policy \
  --role-name GitHubActionsDeploymentRole \
  --policy-arn arn:aws:iam::YOUR-ACCOUNT-ID:policy/GitHubActionsDeploymentPolicy
```

**Replace `YOUR-ACCOUNT-ID` with your actual account ID.**

### 3.5 Get Role ARN

```bash
aws iam get-role \
  --role-name GitHubActionsDeploymentRole \
  --query Role.Arn \
  --output text
```

**Save this ARN!** You'll need it for GitHub Secrets in Labs 2.2, 2.3, and 2.4.

Example: `arn:aws:iam::123456789012:role/GitHubActionsDeploymentRole`

---

## Part 4: Test OIDC Configuration (10 minutes)

### 4.1 Create Test Repository

For testing, create a simple GitHub repository with a workflow that assumes the role:

1. Create new repository: `test-aws-oidc-{your-initials}`
2. Clone it locally

### 4.2 Create Test Workflow

**`.github/workflows/test-oidc.yml`**:

```yaml
name: Test AWS OIDC

on:
  workflow_dispatch:  # Manual trigger

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  test:
    name: Test AWS Authentication
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Test
          aws-region: us-east-1
      
      - name: Test AWS access
        run: |
          echo "Testing AWS authentication..."
          aws sts get-caller-identity | tee caller-identity.json
          
      - name: List EC2 instances
        run: |
          echo "Listing EC2 instances..."
          aws ec2 describe-instances \
            --query 'Reservations[*].Instances[*].[InstanceId,State.Name,Tags[?Key==`Name`].Value|[0]]' \
            --output table | tee ec2-instances.txt
      
      - name: Upload AWS verification artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aws-oidc-verification
          path: |
            caller-identity.json
            ec2-instances.txt
          retention-days: 7
```

### 4.3 Add GitHub Secret

1. Go to repository **Settings** → **Secrets and variables** → **Actions**
2. Click **New repository secret**
3. Add:
   - **Name:** `AWS_ROLE_ARN`
   - **Value:** Your role ARN from Part 3.5

### 4.4 Run Test

1. Go to **Actions** tab in GitHub
2. Select **Test AWS OIDC** workflow
3. Click **Run workflow**
4. Watch the logs

**Expected output:**
```
Configure AWS credentials
Test AWS access - Shows your assumed role identity
List EC2 instances - Shows your EC2 infrastructure
Upload AWS verification artifacts - Saves both outputs
```

### 4.5 Verify Temporary Credentials

Check the "Configure AWS credentials" step output. You'll see something like:
```
Role credentials retrieved successfully
Assuming role: arn:aws:iam::123456789012:role/GitHubActionsAnsibleRole
Credentials will expire in approximately 1 hour
```

**This proves OIDC is working!** No access keys stored anywhere.

### 4.6 View the Artifacts

1. In the workflow run, scroll to the bottom
2. Look for **Artifacts** section
3. Download **aws-oidc-verification** (contains both files)
4. Extract and review both files

**`caller-identity.json` content:**
```json
{
  "UserId": "AROAXXXXXXXXXXXXXXXXX:GitHubActions-Test",
  "Account": "123456789012",
  "Arn": "arn:aws:sts::123456789012:assumed-role/GitHubActionsDeploymentRole/GitHubActions-Test"
}
```

**Notice:**
- `Arn` shows you're using an **assumed role**, not an IAM user
- `UserId` starts with `AROA` (role) not `AKIA` (access key)
- Session name matches what you specified in workflow: `GitHubActions-Test`

**`ec2-instances.txt` content:**
```
-----------------------------------------------------------------
|                      DescribeInstances                        |
+---------------------+-----------+---------------------------+
|  i-0abc123def456789 |  running  |  fastapi-web-server      |
|  i-0def456abc789012 |  stopped  |  jenkins-server          |
+---------------------+-----------+---------------------------+
```

**Why this matters:**
- Proves your role has **real permissions** (not just identity access)
- Shows infrastructure state at time of workflow run
- Common pattern: save infrastructure inventory for audit trails
- Demonstrates multi-file artifact uploads

These artifacts prove that OIDC authentication worked and your role can actually manage AWS resources!

---

## Part 5: Understanding What You Built

### Security Benefits

**No Long-Lived Credentials:**
- Zero AWS access keys stored in GitHub
- Credentials automatically expire after ~1 hour
- Can't be leaked or stolen from secrets

**Principle of Least Privilege:**
- Role only has permissions needed for infrastructure deployment
- Scoped to specific actions
- Can create/modify only necessary AWS resources

**Audit Trail:**
- CloudTrail logs every API call
- Can see which GitHub repository/workflow made each call
- Role session names include workflow information

**Repository Scoping:**
- Trust policy limits access to specific repository
- Other repositories can't assume the role
- Wildcard allows any branch/tag: `repo:user/repo:*`

### How It Works

```
1. GitHub Actions workflow starts
   ↓
2. Workflow requests OIDC token from GitHub
   ↓
3. GitHub issues signed JWT token with claims:
   - Repository name
   - Workflow details
   - Expiration time
   ↓
4. Workflow presents token to AWS STS
   ↓
5. AWS validates token with GitHub OIDC provider
   ↓
6. AWS checks trust policy conditions
   ↓
7. If valid, AWS returns temporary credentials
   ↓
8. Workflow uses credentials (valid ~1 hour)
   ↓
9. Credentials expire automatically
```

---

## Success Criteria

You have successfully completed this lab when:

- [ ] GitHub OIDC provider exists in AWS IAM
- [ ] IAM policy created for EC2
- [ ] IAM role created with proper trust policy
- [ ] Policy attached to role
- [ ] Test workflow runs successfully
- [ ] AWS authentication works without stored credentials
- [ ] Can list EC2 instances via OIDC
- [ ] Artifacts show both identity and EC2 infrastructure state
- [ ] Role ARN saved for use in future labs

---

## Common Trust Policy Patterns

### Single Repository
```json
"token.actions.githubusercontent.com:sub": "repo:username/repo-name:*"
```

### Specific Branch Only
```json
"token.actions.githubusercontent.com:sub": "repo:username/repo-name:ref:refs/heads/main"
```

### Multiple Repositories (same org)
Create separate roles for each repo, or use wildcards (less secure):
```json
"token.actions.githubusercontent.com:sub": "repo:username/*:*"
```

### Environment-Specific
```json
"token.actions.githubusercontent.com:sub": "repo:username/repo-name:environment:production"
```

---

## Troubleshooting

**OIDC provider creation fails:**
- Ensure you have IAM permissions
- Check URL is exact: `https://token.actions.githubusercontent.com`
- Verify audience is: `sts.amazonaws.com`

**Role assumption fails in workflow:**
```yaml
Error: Not authorized to perform sts:AssumeRoleWithWebIdentity
```
Solutions:
- Verify trust policy has correct AWS account ID
- Check repository name matches exactly (case-sensitive)
- Ensure `permissions: id-token: write` in workflow
- Verify OIDC provider exists

**Trust policy syntax error:**
- Use JSON validator
- Check all quotes are straight quotes (not curly)
- Ensure no trailing commas
- Verify ARN format is correct

**Permissions denied during workflow:**
- Check IAM policy attached to role
- Verify actions in policy match what workflow needs
- Test permissions with `aws sts get-caller-identity`

---

## Cleanup

**Don't delete these resources!** You'll need them for Labs 2.2, 2.3, and 2.4.

If you want to clean up the test repository:
```bash
# Delete test repository from GitHub UI
# Or keep it for future OIDC testing
```

To remove everything later (after completing all labs):
```bash
# Detach policy from role
aws iam detach-role-policy \
  --role-name GitHubActionsDeploymentRole \
  --policy-arn arn:aws:iam::YOUR-ACCOUNT-ID:policy/GitHubActionsDeploymentPolicy

# Delete role
aws iam delete-role --role-name GitHubActionsDeploymentRole

# Delete policy
aws iam delete-policy \
  --policy-arn arn:aws:iam::YOUR-ACCOUNT-ID:policy/GitHubActionsDeploymentPolicy

# Delete OIDC provider
aws iam delete-open-id-connect-provider \
  --open-id-connect-provider-arn arn:aws:iam::YOUR-ACCOUNT-ID:oidc-provider/token.actions.githubusercontent.com
```

---

## Key Takeaways

**What You Learned:**
- OpenID Connect (OIDC) authentication flow
- Creating AWS IAM identity providers
- Trust policies for federated authentication
- GitHub Actions OIDC integration
- Temporary credential management
- Security best practices for CI/CD

**Why This Matters:**
- **Security:** No credentials in GitHub = nothing to steal
- **Compliance:** Temporary credentials meet audit requirements
- **Simplicity:** No key rotation or management needed
- **Modern:** Industry standard for cloud CI/CD
- **Scalable:** Same pattern works for any AWS service

**Next Lab:** You'll use this OIDC configuration throughout Labs 2.2-2.4 to run Packer, Terraform, and deployment workflows from GitHub Actions!

---

## Additional Resources

- [GitHub OIDC Documentation](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)
- [AWS IAM OIDC Providers](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc.html)
- [AWS STS AssumeRoleWithWebIdentity](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html)
- [GitHub Actions Security Best Practices](https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions)

---

**Congratulations!** You've configured secure, credential-free authentication between GitHub and AWS. This is production-grade security!
