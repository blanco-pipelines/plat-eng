# Lab 1.2: Simple GitHub Actions Docker Build and Push

## Overview

In this lab, you'll create your first GitHub Actions workflow that automatically builds a Docker image from your FastAPI application and pushes it to Docker Hub whenever you push code to the main branch.

This is a **simple introduction** to GitHub Actions and Docker automation. You'll learn the basics before adding more advanced features like testing and security scanning in later labs.

---

## What You'll Build

A basic CI/CD pipeline that:
1. **Triggers** when you push code to `main`
2. **Builds** a Docker image
3. **Pushes** the image to Docker Hub

That's it! Simple and focused.

---

## Prerequisites

- GitHub account
- Docker Hub account (free tier is fine)
- Basic understanding of Python and Docker
- Git installed locally

---

---

## Part 1: Create a Simple FastAPI Application (10 minutes)

### 1.1 Create Repository

1. Create a new GitHub repository named `fastapi-docker-{your-initials}`
2. Clone it locally:
   ```bash
   git clone https://github.com/your-username/fastapi-docker-{your-initials}.git
   cd fastapi-docker-{your-initials}
   ```

### 1.2 Create Application Structure

Create the following simple structure:

```
fastapi-docker-{your-initials}/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ main.py
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ docker-build.yml
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ Dockerfile
â””â”€â”€ README.md
```

### 1.3 Create the FastAPI Application

**`app/main.py`**:
```python
from fastapi import FastAPI
import uvicorn

app = FastAPI(title="Simple API", version="1.0.0")


@app.get("/")
def read_root():
    return {"message": "Hello from FastAPI!", "version": "1.0.0"}


@app.get("/health")
def health_check():
    return {"status": "healthy"}


if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

### 1.4 Create Requirements File

**`requirements.txt`**:
```
fastapi==0.104.1
uvicorn[standard]==0.24.0
```

### 1.5 Create Dockerfile

**`Dockerfile`**:
```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app/ ./app/

EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 1.6 Test Locally (Optional)

```bash
# Install dependencies
pip install -r requirements.txt

# Run the app
python -m app.main

# Visit http://localhost:8000 to see it running

# Or test with Docker
docker build -t my-fastapi-app .
docker run -p 8000:8000 my-fastapi-app
```

---

## Part 2: Create GitHub Actions Workflow (15 minutes)

### 2.1 Understand GitHub Actions Basics

**Key concepts:**
- **Workflow**: Automated process defined in YAML
- **Trigger**: Event that starts the workflow (like pushing code)
- **Job**: Set of steps that run together
- **Step**: Individual task (like building Docker image)

### 2.2 Create the Workflow File (Your Challenge!)

Create **`.github/workflows/docker-build.yml`** with this starter template:

```yaml
name: Build and Push Docker Image

on:
  push:
    branches: [ main ]

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/fastapi-simple

jobs:
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # TODO: Add step to log in to Docker Hub
      # Hint: Use docker/login-action@v3
      # Needs: username and password from secrets
      
      # TODO: Add step to build and push Docker image
      # Hint: Use docker/build-push-action@v5
      # Needs: context, push: true, and tags
```

**Your Task:**
Complete the workflow by adding the missing steps. You need to:
1. Log in to Docker Hub using `docker/login-action@v3`
2. Build and push the image using `docker/build-push-action@v5`
3. Tag your image with both `latest` and the commit SHA (`${{ github.sha }}`)

**Reference the GitHub Actions marketplace for help:**
- [docker/login-action](https://github.com/docker/login-action)
- [docker/build-push-action](https://github.com/docker/build-push-action)

> **Tip:** The solution is provided at the end of this lab if you get stuck!

---

## Part 3: Configure Secrets and Run (10 minutes)

1. Log in to [Docker Hub](https://hub.docker.com/)
2. Click on your username â†’ **Account Settings**
3. Go to **Security** â†’ **New Access Token**
4. Name it `github-actions`
5. Copy the access token (you won't see it again!)

### 3.2 Add Secrets to GitHub Repository

1. Go to your GitHub repository
2. Click **Settings** â†’ **Secrets and variables** â†’ **Actions**
3. Click **New repository secret**
4. Add two secrets:
   - **Name:** `DOCKER_USERNAME`  
     **Value:** Your Docker Hub username
   - **Name:** `DOCKER_PASSWORD`  
     **Value:** Your Docker Hub access token (from step 3.1)

### 3.3 Push Code and Trigger Workflow

```bash
# Add all files
git add .

# Commit
git commit -m "Add Docker build workflow"

# Push to main branch
git push origin main
```

### 3.4 Watch Your First Automated Build

1. Go to your GitHub repository
2. Click on the **Actions** tab
3. You should see "Build and Push Docker Image" running
4. Click on it to watch the progress
5. Wait for it to complete (usually 2-3 minutes)

**You should see:**
- âœ… Checkout code
- âœ… Log in to Docker Hub
- âœ… Build and push Docker image

### 3.5 Verify on Docker Hub

1. Go to [Docker Hub](https://hub.docker.com/)
2. Navigate to your repositories
3. You should see `fastapi-simple` with two tags:
   - `latest`
   - A commit SHA (like `a1b2c3d`)

---

## Part 4: Test Your Automated Pipeline (10 minutes)

### 4.1 Make a Code Change

Edit `app/main.py` and update the version:

```python
@app.get("/")
def read_root():
    return {"message": "Hello from FastAPI!", "version": "2.0.0"}  # Changed!
```

### 4.2 Push and Watch

```bash
git add app/main.py
git commit -m "Update to version 2.0.0"
git push origin main
```

Go to GitHub Actions and watch your pipeline run automatically!

### 4.3 Pull and Run Your Image

```bash
# Pull the latest image from Docker Hub
docker pull YOUR-USERNAME/fastapi-simple:latest

# Run it
docker run -p 8000:8000 YOUR-USERNAME/fastapi-simple:latest

# Visit http://localhost:8000 to see version 2.0.0
```

---

## Success Criteria

You've completed this lab when:

- [ ] FastAPI app runs locally
- [ ] Dockerfile builds successfully
- [ ] GitHub Actions workflow is configured
- [ ] Workflow triggers on push to main
- [ ] Docker image builds in GitHub Actions
- [ ] Image is pushed to Docker Hub
- [ ] You can pull and run the image from Docker Hub
- [ ] Making code changes triggers automatic rebuild

---

## What You Learned

**GitHub Actions Basics:**
- How workflows are triggered
- Using GitHub secrets for sensitive data
- Checking out code and building Docker images
- Pushing to Docker Hub automatically

**Docker in CI/CD:**
- Building images in automation
- Tagging strategies (`latest` + commit SHA)
- Publishing to container registries

**Continuous Delivery:**
- Code changes automatically build new images
- Images are always ready to deploy
- Manual deployment step (docker pull/run)

---

## Troubleshooting

**"Error: buildx failed"**
- Check Dockerfile syntax
- Test build locally first: `docker build -t test .`

**"Error: unauthorized"**
- Verify `DOCKER_USERNAME` and `DOCKER_PASSWORD` secrets
- Ensure Docker Hub token has push permissions
- Check for typos in secret names

**"Workflow doesn't trigger"**
- Ensure you pushed to `main` branch
- Check workflow file is in `.github/workflows/`
- Verify YAML syntax is correct

---

## Next Steps

Ready for more? Check out **Lab 1.1-enhancements** to add:
- Automated testing
- Code linting and formatting checks
- Security scanning
- Coverage reports
- Pull request checks

---

## Additional Resources

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Docker Hub](https://hub.docker.com/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)

---

**Congratulations!** You've built your first automated Docker build pipeline! Every code push now automatically builds and publishes a new Docker image. ðŸš€

---

## Solution: Complete Workflow File

If you got stuck or want to verify your solution, here's the complete **`.github/workflows/docker-build.yml`**:

```yaml
name: Build and Push Docker Image

on:
  push:
    branches: [ main ]

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/fastapi-simple

jobs:
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:latest
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
```

**Key Points:**
- `docker/login-action@v3` authenticates with Docker Hub using secrets
- `docker/build-push-action@v5` builds and pushes in one step
- `context: .` means build from current directory (where Dockerfile is)
- `push: true` actually pushes to Docker Hub (not just build)
- `tags:` creates two tags: `latest` (for convenience) and commit SHA (for versioning)
