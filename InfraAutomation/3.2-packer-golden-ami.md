# Lab 3.2: Building Golden AMIs with Packer and GitHub Actions

## Overview

In Lab 2.1, you learned that user data has a critical limitation: it only runs when instances **first launch**. When the Auto Scaling Group replaces instances, they start fresh with the original user data configuration.

**The Problem:**
- User data installs Docker and pulls your app
- ASG replaces an instance â†’ New instance starts from scratch
- If you manually updated the app on running instances... **it's gone!** âŒ

**The Solution: Golden AMIs**
Instead of configuring instances after they launch, **bake everything into a custom AMI** (Amazon Machine Image). When ASG launches instances, they're already configured and ready to go!

In this lab, you'll use **Packer** to build custom AMIs and **GitHub Actions** to automate the build process - no local installation required!

**What You'll Build:**
- Packer template that bakes Docker + your application into an AMI
- GitHub Actions workflow to build AMIs automatically
- AMI versioning and tagging strategy
- Fully automated AMI pipeline

**No local Packer installation needed!** Everything runs in CI/CD.

---

## Prerequisites

- Completed Lab 2.1 (Terraform Infrastructure) and **destroyed it**
- Completed Lab 1.4 (GitHub OIDC Setup) - **OIDC provider and IAM role configured**
- Completed Lab 1.0 (Docker image published to Docker Hub)
- GitHub account
- AWS credentials configured locally (for testing)

---

## Architecture Overview

```
GitHub Repository (Packer)
        |
        | (push to main or manual trigger)
        v
GitHub Actions Workflow
        |
        | (assume IAM role via OIDC)
        v
AWS IAM Role (EC2, AMI permissions)
        |
        v
Packer Build Process:
  1. Launch temporary EC2 instance (base Amazon Linux 2023)
  2. Install Docker
  3. Create systemd service to run container on boot
  4. Pull FastAPI image from Docker Hub
  5. Create AMI snapshot
  6. Terminate temporary instance
        |
        v
Custom AMI (tagged with timestamp + version)
  - Docker pre-installed âœ“
  - Application container runs on boot âœ“
  - Ready for ASG to use âœ“
```

**Why This Matters:**
- **Immutable infrastructure:** Every deployment is a new AMI
- **Fast launches:** Instances boot with everything ready
- **Consistent:** All instances identical (no configuration drift)
- **Versioned:** Easy rollbacks to previous AMI versions

---

## Part 1: Create Packer Repository (5 minutes)

### 1.1 Create New Repository

1. Go to GitHub and create a new repository:
   - **Name:** `fastapi-packer-ami-{your-initials}`
   - **Description:** "Packer automation for FastAPI golden AMIs"
   - **Public** (required for OIDC to work easily)
   - Initialize with README

2. Clone it locally:
   ```bash
   git clone https://github.com/your-username/fastapi-packer-ami-{your-initials}.git
   cd fastapi-packer-ami-{your-initials}
   ```

### 1.2 Create Project Structure

```bash
mkdir -p .github/workflows scripts
touch packer.pkr.hcl
touch scripts/setup.sh
touch .github/workflows/build-ami.yml
touch .gitignore
touch README.md
```

Your structure:
```
fastapi-packer-ami-{your-initials}/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ build-ami.yml
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ setup.sh
â”œâ”€â”€ packer.pkr.hcl
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

---

## Part 2: Create Packer Template (15 minutes)

### 2.1 Create .gitignore

**`.gitignore`**:
```
# Packer
*.pkrvars.hcl
crash.log
packer_cache/
manifest.json

# OS
.DS_Store
Thumbs.db

# Editor
.vscode/
.idea/
*.swp
```

### 2.2 Setup Script

**`scripts/setup.sh`**:
```bash
#!/bin/bash
set -e

echo "=== Starting AMI setup ==="

# Update system packages
echo "Updating system packages..."
sudo yum update -y

# Install Docker
echo "Installing Docker..."
sudo yum install -y docker

# Start and enable Docker service
echo "Configuring Docker service..."
sudo systemctl start docker
sudo systemctl enable docker

# Add ec2-user to docker group
sudo usermod -a -G docker ec2-user

# Pull the Docker image
# This will be replaced by Packer variable
echo "Pulling Docker image: ${DOCKER_IMAGE}"
sudo docker pull ${DOCKER_IMAGE}

# Create systemd service to run container on boot
echo "Creating systemd service..."
sudo tee /etc/systemd/system/fastapi-app.service > /dev/null <<EOF
[Unit]
Description=FastAPI Application Container
After=docker.service
Requires=docker.service

[Service]
Type=simple
Restart=always
RestartSec=10
ExecStartPre=-/usr/bin/docker stop fastapi-app
ExecStartPre=-/usr/bin/docker rm fastapi-app
ExecStart=/usr/bin/docker run --rm --name fastapi-app -p 80:8000 ${DOCKER_IMAGE}
ExecStop=/usr/bin/docker stop fastapi-app

[Install]
WantedBy=multi-user.target
EOF

# Enable the service (will start on boot)
sudo systemctl daemon-reload
sudo systemctl enable fastapi-app.service

# Clean up Docker images to reduce AMI size
echo "Cleaning up..."
sudo docker system prune -af

echo "=== AMI setup complete ==="
```

### 2.3 Packer Template

**`packer.pkr.hcl`**:
```hcl
packer {
  required_version = ">= 1.9.0"
  
  required_plugins {
    amazon = {
      source  = "github.com/hashicorp/amazon"
      version = "~> 1.3"
    }
  }
}

# Variables
variable "aws_region" {
  description = "AWS region to build AMI"
  type        = string
  default     = "us-east-1"
}

variable "docker_image" {
  description = "Docker image to bake into AMI"
  type        = string
  # Default to httpd for testing, override with your image
  default     = "httpd:latest"
}

variable "environment" {
  description = "Environment name (dev, staging, prod)"
  type        = string
  default     = "dev"
}

# Data source for latest Amazon Linux 2023 AMI
data "amazon-ami" "amazon_linux_2023" {
  filters = {
    name                = "al2023-ami-*-x86_64"
    virtualization-type = "hvm"
  }
  most_recent = true
  owners      = ["amazon"]
  region      = var.aws_region
}

# Locals for computed values
locals {
  timestamp = regex_replace(timestamp(), "[- TZ:]", "")
  ami_name  = "fastapi-golden-ami-${var.environment}-${local.timestamp}"
}

# Source configuration
source "amazon-ebs" "fastapi" {
  region        = var.aws_region
  source_ami    = data.amazon-ami.amazon_linux_2023.id
  instance_type = "t2.micro"
  ssh_username  = "ec2-user"
  
  # AMI configuration
  ami_name        = local.ami_name
  ami_description = "Golden AMI with Docker and FastAPI application"
  
  # Tags for the AMI
  tags = {
    Name        = local.ami_name
    Environment = var.environment
    Application = "fastapi"
    BuildDate   = local.timestamp
    ManagedBy   = "Packer"
    DockerImage = var.docker_image
  }
  
  # Tags for the temporary instance during build
  run_tags = {
    Name      = "packer-builder-fastapi"
    ManagedBy = "Packer"
    Temporary = "true"
  }
}

# Build configuration
build {
  sources = ["source.amazon-ebs.fastapi"]
  
  # Set environment variable for Docker image
  provisioner "shell" {
    environment_vars = [
      "DOCKER_IMAGE=${var.docker_image}"
    ]
    script = "scripts/setup.sh"
  }
  
  # Verify the setup
  provisioner "shell" {
    inline = [
      "echo 'Verifying Docker installation...'",
      "docker --version",
      "echo 'Verifying systemd service...'",
      "sudo systemctl status fastapi-app.service || true",
      "echo 'Setup verification complete!'"
    ]
  }
  
  # Output AMI details
  post-processor "manifest" {
    output = "manifest.json"
    strip_path = true
  }
}
```

---

## Part 3: Create GitHub Actions Workflow (15 minutes)

### 3.1 GitHub Actions Workflow

**`.github/workflows/build-ami.yml`**:
```yaml
name: Build AMI with Packer

on:
  workflow_dispatch:
    inputs:
      docker_image:
        description: 'Docker image to bake into AMI'
        required: true
        default: 'your-dockerhub-username/fastapi-cicd:latest'
      environment:
        description: 'Environment (dev, staging, prod)'
        required: false
        default: 'dev'

permissions:
  id-token: write  # Required for OIDC
  contents: read

env:
  AWS_REGION: us-east-1
  PACKER_VERSION: "1.10.0"

jobs:
  build-ami:
    name: Build Golden AMI
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Packer
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Verify AWS credentials
        run: |
          aws sts get-caller-identity
          echo "âœ… AWS credentials configured successfully"
      
      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}
      
      - name: Initialize Packer
        run: packer init packer.pkr.hcl
      
      - name: Validate Packer template
        run: packer validate packer.pkr.hcl
      
      - name: Build AMI
        run: |
          packer build \
            -var "aws_region=${{ env.AWS_REGION }}" \
            -var "docker_image=${{ github.event.inputs.docker_image || 'httpd:latest' }}" \
            -var "environment=${{ github.event.inputs.environment || 'dev' }}" \
            packer.pkr.hcl
      
      - name: Extract AMI ID
        id: ami
        run: |
          AMI_ID=$(jq -r '.builds[-1].artifact_id' manifest.json | cut -d':' -f2)
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
          echo "### AMI Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**AMI ID:** \`$AMI_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Image:** ${{ github.event.inputs.docker_image || 'httpd:latest' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Use this AMI ID in your Terraform configuration!" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload manifest
        uses: actions/upload-artifact@v4
        with:
          name: packer-manifest
          path: manifest.json
          retention-days: 30
    
    outputs:
      ami_id: ${{ steps.ami.outputs.ami_id }}
```

---

## Part 4: Configure GitHub Secrets (2 minutes)

### 4.1 Add Secrets

1. Go to your Packer repository on GitHub
2. Click **Settings** â†’ **Secrets and variables** â†’ **Actions**
3. Add (if not already added):
   - **Name:** `AWS_ROLE_ARN`
   - **Value:** Your OIDC role ARN from Lab 1.4

---

## Part 5: Build Your First AMI (20 minutes)

### 5.1 Update Docker Image Reference

Edit `.github/workflows/build-ami.yml` and update the default Docker image:

```yaml
docker_image:
  description: 'Docker image to bake into AMI'
  required: true
  default: 'your-dockerhub-username/fastapi-cicd:latest'  # UPDATE THIS!
```

### 5.2 Commit and Push

```bash
git add .
git commit -m "Add Packer template and GitHub Actions workflow"
git push origin main
```

### 5.3 Trigger the Build

1. Go to your GitHub repository
2. Click **Actions** â†’ **Build AMI with Packer**
3. Click **Run workflow**
4. Enter your Docker image (e.g., `yourusername/fastapi-cicd:latest`)
5. Environment: `dev`
6. Click **Run workflow**

### 5.4 Monitor the Build

The workflow will:
1. âœ… Configure AWS credentials via OIDC
2. âœ… Setup Packer
3. âœ… Validate template
4. âœ… Launch temporary EC2 instance
5. âœ… Install Docker and pull your image
6. âœ… Create systemd service
7. âœ… Create AMI snapshot
8. âœ… Terminate temporary instance
9. âœ… Output AMI ID

**Build time:** ~10-15 minutes (mostly waiting for AMI snapshot)

### 5.5 Verify AMI Creation

After the workflow completes:

```bash
# Get the AMI ID from the workflow summary
AMI_ID="ami-xxxxx"  # Replace with actual ID

# Describe the AMI
aws ec2 describe-images --image-ids $AMI_ID --region us-east-1

# Should show your custom AMI with tags
```

Or check in AWS Console:
1. **EC2** â†’ **AMIs**
2. Find AMI with name: `fastapi-golden-ami-dev-TIMESTAMP`
3. Verify tags: Environment, Application, DockerImage, etc.

---

## Part 6: Test the AMI (10 minutes)

### 6.1 Launch Test Instance

Let's verify the AMI works by launching a single instance:

```bash
# Get default VPC
VPC_ID=$(aws ec2 describe-vpcs --filters "Name=is-default,Values=true" --query 'Vpcs[0].VpcId' --output text)

# Get a subnet
SUBNET_ID=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" --query 'Subnets[0].SubnetId' --output text)

# Create security group
SG_ID=$(aws ec2 create-security-group \
  --group-name test-ami-sg \
  --description "Test AMI security group" \
  --vpc-id $VPC_ID \
  --query 'GroupId' --output text)

# Allow HTTP
aws ec2 authorize-security-group-ingress \
  --group-id $SG_ID \
  --protocol tcp \
  --port 80 \
  --cidr 0.0.0.0/0

# Launch instance with your AMI
INSTANCE_ID=$(aws ec2 run-instances \
  --image-id $AMI_ID \
  --instance-type t2.micro \
  --security-group-ids $SG_ID \
  --subnet-id $SUBNET_ID \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=ami-test}]' \
  --query 'Instances[0].InstanceId' --output text)

echo "Instance launched: $INSTANCE_ID"
```

### 6.2 Wait and Verify

```bash
# Wait for instance to be running
aws ec2 wait instance-running --instance-ids $INSTANCE_ID

# Get public IP
PUBLIC_IP=$(aws ec2 describe-instances \
  --instance-ids $INSTANCE_ID \
  --query 'Reservations[0].Instances[0].PublicIpAddress' \
  --output text)

echo "Access your app at: http://$PUBLIC_IP"

# Wait a minute for the service to start, then test
sleep 60
curl http://$PUBLIC_IP
```

**Expected:** You should see your FastAPI application response or Apache "It works!" page!

### 6.3 Cleanup Test Instance

```bash
# Terminate instance
aws ec2 terminate-instances --instance-ids $INSTANCE_ID

# Delete security group (wait for instance to terminate first)
aws ec2 wait instance-terminated --instance-ids $INSTANCE_ID
aws ec2 delete-security-group --group-id $SG_ID
```

---

## Part 7: Understanding the AMI Build Process

### 7.1 What Packer Does

**Build Steps:**
1. **Launch temporary instance:** Uses base Amazon Linux 2023 AMI
2. **Connect via SSH:** Waits for instance to be ready
3. **Run provisioners:** Executes `scripts/setup.sh`
   - Install Docker
   - Pull your Docker image
   - Create systemd service to run container on boot
4. **Create AMI:** Snapshots the configured instance
5. **Tag AMI:** Adds metadata (timestamp, docker image, etc.)
6. **Cleanup:** Terminates temporary instance

**Result:** Custom AMI ready for production use!

### 7.2 AMI Versioning Strategy

Your AMIs are automatically versioned using:
- **Name:** `fastapi-golden-ami-dev-20250101123045`
  - Includes environment and timestamp
  - Unique name for each build
  
- **Tags:**
  - `Environment`: dev/staging/prod
  - `BuildDate`: Timestamp
  - `DockerImage`: The image baked in
  - `ManagedBy`: Packer

**Finding Latest AMI:**
In Terraform (next lab), you'll use a data source that finds the most recent AMI by `BuildDate` tag.

---

## Success Criteria

You have successfully completed this lab when:

- [ ] Packer template builds successfully in GitHub Actions
- [ ] AMI is created and tagged properly
- [ ] Can launch an EC2 instance from the AMI
- [ ] Application runs automatically on boot (no manual configuration)
- [ ] Build process is fully automated (no local Packer installation)
- [ ] AMI ID is captured in workflow outputs

---

## Understanding Immutable Infrastructure

### What You Built

**Immutable Infrastructure Pattern:**
- Never modify running instances
- Every change = new AMI
- Old AMIs kept for rollback
- Instances are disposable

**Benefits:**
- **Consistency:** All instances identical
- **Fast deployments:** Instances boot ready to serve
- **Easy rollbacks:** Switch back to previous AMI
- **No configuration drift:** Can't manually change instances
- **Auditable:** Every AMI tagged with what's inside

**Comparison:**

| Approach | Configuration Time | Consistency | Rollback |
|----------|-------------------|-------------|----------|
| User Data | ~5 min per instance | Varies | Hard |
| Ansible | ~2 min per instance | Drift possible | Hard |
| **Golden AMI** | **Instant** | **Perfect** | **Easy** |

---

## Troubleshooting

**Packer build fails - SSH timeout:**
```bash
# Check if temporary instance launched
aws ec2 describe-instances --filters "Name=tag:Name,Values=packer-builder-fastapi"

# Verify security group allows SSH from GitHub Actions IP
# Packer automatically creates security group with SSH access
```

**AMI build succeeds but instance won't boot:**
```bash
# Check systemd service logs on test instance
ssh ec2-user@<instance-ip>
sudo journalctl -u fastapi-app.service -f

# Common issue: Docker image not found
# Make sure Docker image exists on Docker Hub
```

**"Permission denied" errors in Packer:**
- Verify IAM role has all EC2 permissions from Part 3.1
- Check OIDC trust relationship allows your repository

**Build takes too long:**
- AMI snapshot is the slowest part (~5-10 min)
- Consider using smaller base AMIs
- Use faster instance types for build (e.g., t3.small)

---

## Key Takeaways

**What You Learned:**
- Building custom AMIs with Packer
- Automating AMI builds in CI/CD
- Immutable infrastructure patterns
- AMI versioning and tagging
- systemd service management

**Why This Matters:**
- **Production-grade:** This is how real companies deploy
- **Fast scaling:** ASG can launch hundreds of instances instantly
- **Reliable:** Every instance boots identically configured
- **Auditable:** Know exactly what's in each AMI
- **Rollback-friendly:** Keep old AMIs for instant rollback

**Next Lab:** You'll use Terraform to deploy infrastructure with your custom AMI and implement zero-downtime rolling deployments!

---

## Bonus Challenges

Want to level up? Try these:

1. **Multi-region AMIs:**
   - Copy AMI to multiple regions
   - Packer `post-processor` for `amazon-import`

2. **Automated testing:**
   - Launch instance after AMI build
   - Run integration tests
   - Terminate if tests fail

3. **AMI cleanup:**
   - Automatically deregister old AMIs
   - Keep only last 5 versions
   - Lambda function or GitHub Actions

4. **Environment-specific images:**
   - Different AMIs for dev/staging/prod
   - Different Docker image tags per environment

5. **Build notifications:**
   - Slack notification when AMI ready
   - Include AMI ID in message

---

## Additional Resources

- [Packer Documentation](https://developer.hashicorp.com/packer/docs)
- [Packer Amazon EBS Builder](https://developer.hashicorp.com/packer/plugins/builders/amazon/ebs)
- [AWS AMI Best Practices](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html)
- [Immutable Infrastructure](https://www.hashicorp.com/resources/what-is-mutable-vs-immutable-infrastructure)

---

**Congratulations!** You've automated the creation of production-ready golden AMIs! ðŸš€
